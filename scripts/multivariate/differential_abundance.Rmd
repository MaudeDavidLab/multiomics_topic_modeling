---
title: "differential_abundance"
output: html_document
---

```{r}
library(vegan)
library(phyloseq)
library(dplyr)
library(lme4)
library(caret)
library(DESeq2)
library(ape)
library(reshape2)
library(randomForest)
library(caret)
library(KEGGREST)
library(pROC)
library(glmnet)
library(patchwork)
library(VennDiagram)
library(ggVennDiagram)
library(ggpubr)
library(ggplotify)
library(colorspace)
library(aod)

```

```{r}
setwd("C:/Users/kitikomp/Documents/Lab/M3")
source('scripts/clean_mapping_ml.R')
ps_16s <- readRDS("data/16s/ps_clr_nooutliers.rds")
ps_mtg <- readRDS("data/mtg/ps_tmm_nooutliers.rds")
ps_mtg@sam_data$familyID <- as.character(ps_mtg@sam_data$familyID)
ps_mtt <- readRDS("data/mtt/ps_clr_nooutliers.rds")
ps_metabol <- readRDS("data/metabol/ps_tmm_nooutliers_fixedmapping.rds")
```

```{r}
asd_color <- "#01898D"
td_color <- "#67A102"
```

# Wald Test Definition
```{r}
myWaldTest <- function(df){
  pvals <- sapply(colnames(df), function(x){
    f <- formula(paste("phenotype ~ ", x))
    line <- glm(f, data = df, family = "binomial")
    res <- wald.test(b = coef(line), Sigma = vcov(line), Terms = 1)
    pval <- res$result$chi2[3]
    return(pval)
  })
  return(pvals)
}

```

# Plot Densities
```{r,  fig.height = 8, fig.width = 4}
plotDensities <- function(df, pvals,  getGeneName, ncols = 1){
  tmp <- melt(df, id = "phenotype")
  tmp$value <- tmp$value + .00001
  tmp$phenotype <- ifelse(tmp$phenotype == 1, "ASD", "TD")
  tmp_td <- tmp[tmp$phenotype == "TD", ]
  medians<- tmp %>% group_by(variable) %>% summarize(median = median(value))
  medians <- as.data.frame(medians)
  rownames(medians) <- medians$variable
  tmp$td_median <- medians[tmp$variable, 'median']
  
  
  ggplot(data = tmp, aes(y = log2(value/td_median), fill = phenotype), colour = "grey") + geom_histogram(bins = 50) + facet_grid(vars(variable)) + coord_flip() + geom_hline(yintercept = 0, colour = "blue")
  
  variables <- unique(tmp$variable)
  labels <- c(round(pvals[variables], 3))
  
  if(getGeneName){
       kegg_res <- keggGet(names(labels))
      full_names <- unlist(lapply(kegg_res, function(x) return(x$NAME)))
      full_names <- sub("\\[.*?\\]", "", full_names)
      full_names <- gsub ("\\/", "\n", full_names)
      full_names <- gsub (",", "\n", full_names)

      names(full_names) <- names(labels)
      tmp$variable <- paste(tmp$variable, "\n", full_names[tmp$variable], "\n", " p = ", labels[tmp$variable])
  }else{
      tmp$variable <- paste(tmp$variable, "\n", " p = ", labels[tmp$variable])
  }



  p <- ggplot(data = tmp, aes(y = log2(value/td_median), fill = phenotype), colour = "grey") +
    geom_density( alpha = 0.5) +
    facet_wrap(vars(variable), strip.position = "bottom", ncol = ncols, scales = "free") +
    coord_flip() +
    geom_hline(yintercept = 0, colour = "blue") +
    theme_bw() + theme(strip.background =element_rect(fill="white"))+
    scale_fill_manual(values = list("ASD" = asd_color, "TD" = td_color))+
    labs(y = "log_10(abundance relative to TD median)", x = "Density")
  p
  return(p)
}
```

# Plot Boxplots
```{r}
plotBoxplots <- function(df, pvals, getGeneName =F, ncols = 1){
  tmp <- melt(df, id = "phenotype")
  tmp$phenotype <- ifelse(tmp$phenotype == 1, "ASD", "TD")
  tmp_td <- tmp[tmp$phenotype == "TD", ]
  medians<- tmp %>% group_by(variable) %>% summarize(median = median(value))
  medians <- as.data.frame(medians)
  rownames(medians) <- medians$variable
  tmp$td_median <- medians[tmp$variable, 'median']

  
  variables <- unique(tmp$variable)
  labels <- c(round(pvals[variables], 3))
  
  if(getGeneName){
       kegg_res <- keggGet(names(labels))
      full_names <- unlist(lapply(kegg_res, function(x) return(x$NAME)))
      full_names <- sub("\\[.*?\\]", "", full_names)
      full_names <- gsub ("\\/", "\n", full_names)
      full_names <- gsub (",", "\n", full_names)

      names(full_names) <- names(labels)
      tmp$variable <- paste(tmp$variable, "\n", full_names[tmp$variable], "\n", " p = ", labels[tmp$variable])
  }else{
      tmp$variable <- paste(tmp$variable, "\n", " p = ", labels[tmp$variable])
  }

  ggplot(data = tmp, aes(x = phenotype, y = log2(value/td_median), fill = phenotype), colour = "grey") +
    geom_boxplot() + geom_jitter(width = 0.1)+
    facet_wrap(vars(variable), strip.position = "bottom", ncol = ncols, scales = "free") +
    geom_hline(yintercept = 0, colour = "blue") +
    theme_bw() + theme(strip.background =element_rect(fill="white"))+
    scale_fill_manual(values = list("ASD" = asd_color, "TD" = td_color))+
    labs(y = "log_10(abundance relative to TD median)", x = "Density")
}
```


# MTG DA Wald Test
```{r}
df <- as.data.frame(t(ps_mtg@otu_table))
df$phenotype <- ifelse(ps_mtg@sam_data$phenotype == "A", 1, 0)
  
pvals <- myWaldTest(df)
print(sum(pvals < .01))
toplot <- taxa_names(ps_mtg)[which(pvals < .01)]
pvals <- pvals[pvals < .01]
names(pvals) <- toplot

df <- as.data.frame(t(ps_mtg@otu_table))
df <- df[ , toplot]
df$phenotype <- ifelse(ps_mtg@sam_data$phenotype == "A", 1, 0)
p <- plotDensities(df, pvals, getGeneName = T)
ggsave("../results/differential_analysis/mtg/density_plots.pdf", height = 8, width = 5)
```


# MTT DA Wald Test
```{r}
alpha = 0.1
df <- as.data.frame(t(ps_mtt@otu_table))
df$phenotype <- ifelse(ps_mtt@sam_data$phenotype == "A", 1, 0)

pvals <- myWaldTest(df)
print(sum(pvals < alpha))
toplot <- taxa_names(ps_mtt)[which(pvals < alpha)]
pvals <- pvals[pvals < alpha]
names(pvals) <- toplot


df <- as.data.frame(t(ps_mtt@otu_table))
df <- df[ , toplot]
df$phenotype <- ifelse(ps_mtt@sam_data$phenotype == "A", 1, 0)
p <- plotDensities(df, pvals, getGeneName = T)
ggsave("../results/differential_analysis/mtt/density_plots.pdf", height = 10, width = 5)

```

# Metabolite DA Wald Test
Density plots of differentially abundant metabolites, Wald test
```{r}
alpha = 0.1
#wald test
df <- as.data.frame(t(ps_metabol@otu_table))
df$phenotype <- ifelse(ps_metabol@sam_data$phenotype == "A", 1, 0)
colnames(df) <- gsub("-", ".", colnames(df))
colnames(df) <- gsub(",", ".", colnames(df))
colnames(df) <- gsub("\\(", ".", colnames(df))
colnames(df) <- gsub("\\)", ".", colnames(df))
colnames(df) <- gsub(" ", ".", colnames(df))
colnames(df) <- gsub("\\*", ".", colnames(df))
colnames(df) <- gsub("\\^", ".", colnames(df))
colnames(df) <- gsub("\\+", ".", colnames(df))
colnames(df) <- gsub("\\/", ".", colnames(df))
colnames(df) <- gsub("\\[", ".", colnames(df))
colnames(df) <- gsub("\\:", ".", colnames(df))
colnames(df) <- gsub("\\;", ".", colnames(df))
colnames(df) <- gsub("\\]", ".", colnames(df))

colnames(df) <- gsub('[[:digit:]]+', '', colnames(df))
pvals <- sapply(colnames(df), function(x){
  f <- formula(paste("phenotype ~ ", x))
  line <- glm(f, data = df, family = "binomial")
  res <- wald.test(b = coef(line), Sigma = vcov(line), Terms = 1)
  pval <- res$result$chi2[3]
  return(pval)
})

toplot <- taxa_names(ps_metabol)[which(pvals < alpha)]
pvals <- pvals[pvals < alpha]
names(pvals) <- toplot

df <- as.data.frame(t(ps_metabol@otu_table))
df <- df[ , toplot]
df$phenotype <- ifelse(ps_metabol@sam_data$phenotype == "A", 1, 0)
p <- plotDensities(df, pvals)
ggsave("../results/differential_analysis/metabol/density_plots.pdf", height = 8, width = 4)
```

# DESeq2 differential abundance
```{r}
tmp_getSig <- function(diagdds){
  diagdds <- estimateSizeFactors(diagdds, type = "poscounts")
  diagdds <- DESeq(diagdds,fitType="parametric", betaPrior = FALSE) 
  res = results(diagdds, contrast = c("phenotype", "N", "A"))
  res$padj[is.na(res$padj)] = 1
  sig <- res[res$padj < dcut,]
  if (dim(sig)[1] == 0) {
    sig<- as.data.frame(1, row.names="nothing")
    colnames(sigtab) <- 'padj'
  }

  sigtab <- data.frame(sig)
  return(sigtab)
}

runDESeq <- function(ps, dcut = 0.05, control_variables){
  library("BiocParallel")
  register(SnowParam(4))

  ps@sam_data$racial_group <- as.factor(ps@sam_data$racial_group)
  ps@sam_data$phenotype <- as.factor(ps@sam_data$phenotype)
  ps@sam_data$sex <- as.factor(ps@sam_data$sex)
  ps@sam_data$age <- as.numeric(ps@sam_data$age)
  
  #ps@sam_data$dietary_supplement[is.na(ps@sam_data$dietary_supplement)] = "FALSE"
  #ps@sam_data$dietary_supplement[ps@sam_data$dietary_supplement == "False"] = "FALSE"
  #ps@sam_data$dietary_supplement[ps@sam_data$dietary_supplement == "True"] = "TRUE"
  #ps@sam_data$dietary_supplement <- as.factor(ps@sam_data$dietary_supplement)
  
  keep <- apply(ps@sam_data[ , control_variables], 2, function(x){
    return(!is.na(x))
  })
  keep <- rowSums(keep) == length(control_variables)
  ps <- prune_samples(as.logical(keep), ps)
  
  #normalize
  control_variables <- c(control_variables, "age")
  ps@sam_data[ , control_variables] <- apply(ps@sam_data[ , control_variables], 2, function(x){
    return((x - mean(x)) / var(x))
  })
  
  # formula
  #control_variables <- c(control_variables, "sex")
  f <- formula(paste("~ ", paste(control_variables, collapse = "+"), "+ phenotype"))
  f
  
  #diagdds = phyloseq_to_deseq2(ps, ~ phenotype + sex + racial_group + vitamin_B + dog)
  # meal_ready_eat + fat_oil_freq + fruit are those that are significant in a permanova of all dietary variables
  #vitamin B appears in the metabolite data, which means we should probably control for supplementation
  #racial group is very influential, probably because it's a soft proxy for family id
  #Include all variables significant in a permanova
  diagdds = phyloseq_to_deseq2(ps, f) 
  
  diagdds <- estimateSizeFactors(diagdds, type = "poscounts")
  diagdds <- DESeq(diagdds,fitType="local", betaPrior = FALSE) 
  res = results(diagdds, contrast = c("phenotype", "N", "A"))
  #res <- lfcShrink(dds, coef="condition_trt_vs_untrt", type="apeglm")
  res$padj[is.na(res$padj)] = 1
  sig <- res[res$padj < dcut,]
  #if (dim(sig)[1] == 0) {
  #  sig<- as.data.frame(1, row.names="nothing")
  #  colnames(sig) <- 'padj'
  #}

  #sigtab <- data.frame(sig)
  return(list(res, sig))
}
```

```{r}
alpha = 0.05
deseq_mtg <- runDESeq(ps_mtg, dcut = alpha)
deseq_mtt <- runDESeq(ps_mtt, dcut = alpha)
deseq_metabol <- runDESeq(ps_metabol, dcut = alpha)


saveRDS(deseq_mtg, "../results/differential_analysis/mtg/deseq_full.rds")
saveRDS(deseq_mtt, "../results/differential_analysis/mtt/deseq_full.rds")
saveRDS(deseq_metabol, "../results/differential_analysis/metabol/deseq_full.rds")
#Which control factors make 5 dodecenoate disappear as a metabolite
```

#Save DESeq results all
```{r}
#to match gsea code, we need negative to mean more in the NT and positive to mean more in the ASD
mtg_ranked <- data.frame(kegg_id = rownames(deseq_mtg[[1]]), score = -deseq_mtg[[1]]$log2FoldChange)

mtt_ranked <- data.frame(kegg_id = rownames(deseq_mtt[[1]]), score = -deseq_mtt[[1]]$log2FoldChange)

write.csv(mtg_ranked, "../results/gsea/mtg_ranked_deseq.csv", quote = F, row.names = F)
write.csv(mtt_ranked, "../results/gsea/mtt_ranked_deseq.csv", quote = F, row.names = F)
```

# Save DESeq results
```{r}
getFullGeneName <- function(x){
  tmp <- keggGet(x)
  return(tmp[[1]]$NAME)
}

tmp <- deseq_mtg[[2]]
tmp$full_name <- sapply(rownames(tmp), getFullGeneName)
saveRDS(tmp, "../results/differential_analysis/mtg/deseq.rds")

tmp <- deseq_mtt[[2]]
tmp$full_name <- sapply(rownames(tmp), getFullGeneName)
saveRDS(tmp, "../results/differential_analysis/mtt/deseq.rds")

tmp <- deseq_metabol[[2]]
saveRDS(tmp, "../results/differential_analysis/metabol/deseq.rds")
```

# Check if there is overlap between mtg and mtt
```{r}
genes <- intersect(rownames(deseq_mtg[[2]]), rownames(deseq_mtt[[2]]))

deseq_mtg[[2]][genes, ]
deseq_mtt[[2]][genes, ]

sapply(genes, getFullGeneName)
```

# Density plots of these 3 genes
```{r}
#Plot mtg version
deseq_mtg <- readRDS( "../results/differential_analysis/mtg/deseq.rds")
toplot <- genes
pvals <- deseq_mtg[toplot, 'padj']
names(pvals) <- toplot

df <- as.data.frame(t(ps_mtg@otu_table))
df <- df[ , toplot]
df$phenotype <- ifelse(ps_mtg@sam_data$phenotype == "A", 1, 0)
p <- plotDensities(df, pvals, getGeneName = T, ncol = 1)
ggsave("../results/differential_analysis/mtg/deseq_densities.png", width = 4, height = 6)
ggsave("../results/differential_analysis/mtg/deseq_densities.pdf", width = 4, height = 6)

p <- plotBoxplots(df, pvals, getGeneName = T)
ggsave("../results/differential_analysis/mtg/deseq_boxplots.png", width = 4)
ggsave("../results/differential_analysis/mtg/deseq_boxplots.pdf", width = 4)


#Plot mtt version
deseq_mtt <- readRDS( "../results/differential_analysis/mtt/deseq.rds")
toplot <- genes
pvals <- deseq_mtt[toplot, 'padj']
names(pvals) <- toplot

df <- as.data.frame(t(ps_mtt@otu_table))
df <- df[ , toplot]
df$phenotype <- ifelse(ps_mtt@sam_data$phenotype == "A", 1, 0)
p <- plotDensities(df, pvals, getGeneName = T)
ggsave("../results/differential_analysis/mtt/deseq_densities.png", width = 4)
ggsave("../results/differential_analysis/mtt/deseq_densities.pdf", width = 4)

p <- plotBoxplots(df, pvals, getGeneName = T)
ggsave("../results/differential_analysis/mtt/deseq_boxplots.png", width = 4)
ggsave("../results/differential_analysis/mtt/deseq_boxplots.pdf", width = 4)
```

# Density plots of the metabolites
```{r}
deseq_metabol <- readRDS( "../results/differential_analysis/metabol/deseq.rds")
toplot <- rownames(deseq_metabol)
toplot <- toplot[toplot != "levetiracetam"]
pvals <- deseq_metabol[toplot, 'padj']
names(pvals) <- toplot

df <- as.data.frame(t(ps_metabol@otu_table))
df <- df[ , toplot]
df$phenotype <- ifelse(ps_metabol@sam_data$phenotype == "A", 1, 0)
p <- plotDensities(df, pvals, getGeneName = F, ncol = 2)
ggsave("../results/differential_analysis/metabol/deseq_densities.png", width = 9, height = 7)
ggsave("../results/differential_analysis/metabol/deseq_densities.pdf", width = 9, height = 7)

p <- plotBoxplots(df, pvals, getGeneName = F, ncol = 2)
ggsave("../results/differential_analysis/metabol/deseq_boxplots.png", width = 4)

```

# Correlation with stool frequency
```{r, fig.height = 7, fig.width = }
plotCorrelationStoolFreq <- function(toplot, ps, getGeneName = F){
  df <- as.data.frame(t(ps@otu_table))
  df <- df[ , toplot, drop = F]
  df$stool_freq <- as.numeric(ps@sam_data$stool_freq)
  df$age <- as.numeric(ps@sam_data$age)
  
  tmp <- melt(df, id = c("stool_freq", "age"))
  
  pvals <- sapply(unique(tmp$variable), function(x){
    tmp_use <- tmp[tmp$variable == x, ]
    res <- PResiduals::partial_Spearman(formula("stool_freq | value ~ age"), tmp_use)
    pval <- res$TS$TB$pval
    return(pval)
    #return(cor.test(tmp_use$value , tmp_use$stool_freq, method = "spearman")$p.value)
  })
  names(pvals) <- unique(tmp$variable)
  variables <- unique(tmp$variable)
  labels <- c(round(pvals[variables], 3))
  
  if(getGeneName){
       kegg_res <- keggGet(names(labels))
      full_names <- unlist(lapply(kegg_res, function(x) return(x$NAME)))
      full_names <- sub("\\[.*?\\]", "", full_names)
      full_names <- gsub ("\\/", "\n", full_names)
      full_names <- gsub (",", "\n", full_names)

      names(full_names) <- names(labels)
      tmp$variable <- paste(tmp$variable, "\n", full_names[tmp$variable], "\n", " p = ", labels[tmp$variable])
  }else{
      tmp$variable <- paste(tmp$variable, "\n", " p = ", labels[tmp$variable])
  }
  
  p <- ggplot(tmp, aes(x = log(value), y = stool_freq)) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(vars(variable), ncol = 2, scale = "free") +
    theme_bw()+ theme(strip.background =element_rect(fill="white"))
  return(p)
}


deseq_metabol <- readRDS("../results/differential_analysis/metabol/deseq.rds")
deseq_mtg <- readRDS("../results/differential_analysis/mtg/deseq.rds")
deseq_mtt <- readRDS("../results/differential_analysis/mtt/deseq.rds")
genes <- intersect(rownames(deseq_mtg), rownames(deseq_mtt))

toplot <- rownames(deseq_metabol)
toplot <-toplot[!toplot %in% c("levetiracetam")]
plotCorrelationStoolFreq(toplot, ps_metabol)
ggsave("../results/differential_analysis/metabol/corr_stool.pdf", width = 5, height = 6)
  
toplot <- genes
plotCorrelationStoolFreq(toplot, ps_mtg, getGeneName = T)
ggsave("../results/differential_analysis/mtg/corr_stool.pdf", width = 5, height = 6)

toplot <- genes
plotCorrelationStoolFreq(toplot, ps_mtt, getGeneName = T)
ggsave("../results/differential_analysis/mtt/corr_stool.pdf", width = 5, height = 4)

```

# Correlation with GI distress
```{r, fig.height = 7, fig.width = }
plotCorrelationGIDistress <- function(toplot, ps, getGeneName = F){
  df <- as.data.frame(t(ps@otu_table))
  df <- df[ , toplot, drop = F]
  df$gi_issues <- as.logical(ps@sam_data$GI_issues_this_week)
  
  tmp <- melt(df, id = c("gi_issues"))
  
  pvals <- sapply(unique(tmp$variable), function(x){
    tmp_use <- tmp[tmp$variable == x, ]
    return(wilcox.test(tmp_use$value[tmp_use$gi_issues == TRUE] ,
                       tmp_use$value[tmp_use$gi_issues == FALSE])$p.value)
  })
  names(pvals) <- unique(tmp$variable)
  variables <- unique(tmp$variable)
  labels <- c(round(pvals[variables], 3))
  
  if(getGeneName){
       kegg_res <- keggGet(names(labels))
      full_names <- unlist(lapply(kegg_res, function(x) return(x$NAME)))
      full_names <- sub("\\[.*?\\]", "", full_names)
      full_names <- gsub ("\\/", "\n", full_names)
      full_names <- gsub (",", "\n", full_names)

      names(full_names) <- names(labels)
      tmp$variable <- paste(tmp$variable, "\n", full_names[tmp$variable], "\n", " p = ", labels[tmp$variable])
  }else{
      tmp$variable <- paste(tmp$variable, "\n", " p = ", labels[tmp$variable])
  }
  
  p <- ggplot(tmp, aes(x = gi_issues, y = log(value))) +
    geom_boxplot() +
    geom_jitter(width = 0.2)+
    facet_wrap(vars(variable), ncol = 2, scale = "free") +
    theme_bw()+ theme(strip.background =element_rect(fill="white"))
  return(p)
}

toplot <- rownames(deseq_metabol)
toplot <- rownames(deseq_metabol)[!rownames(deseq_metabol) %in% c("levetiracetam")]
plotCorrelationGIDistress(toplot, ps_metabol)
ggsave("../results/differential_analysis/metabol/corr_GI.pdf", width = 5, height = 6)
  
toplot <-  genes
plotCorrelationGIDistress(toplot, ps_mtg, getGeneName = T)
ggsave("../results/differential_analysis/mtg/corr_GI.pdf", width = 5, height = 6)

#toplot <- genes
#plotCorrelationGIDistress(toplot, ps_mtt, getGeneName = T)
#ggsave("../results/differential_analysis/mtt/corr_GI.pdf", width = 5, height = 4)

```



# Correlation with alpha diversity
```{r}
plotCorrelationAlphaDiversity <- function(toplot, ps, getGeneName = F, ncol = 1){
  samples <- intersect(sample_names(ps), sample_names(ps_16s))
  ps <- prune_samples(samples, ps)
  ps_16s <- prune_samples(samples, ps_16s)
  df <- as.data.frame(t(ps@otu_table))
  df <- df[ , toplot, drop = F]
  
  
  
  df$diversity <- unlist(estimate_richness(ps_16s, measures = "shannon"))
  df$age <- as.numeric(ps_16s@sam_data$age)
  
  tmp <- melt(df, id = c("diversity", "age"))
  
  pvals <- sapply(unique(tmp$variable), function(x){
    tmp_use <- tmp[tmp$variable == x, ]
    res <- PResiduals::partial_Spearman(formula("diversity | value ~ age"), tmp_use)
    pval <- res$TS$TB$pval
    return(pval)
    #return(cor.test(tmp_use$value , tmp_use$stool_freq, method = "spearman")$p.value)
  })
  names(pvals) <- unique(tmp$variable)
  variables <- unique(tmp$variable)
  labels <- c(round(pvals[variables], 3))
  
  if(getGeneName){
       kegg_res <- keggGet(names(labels))
      full_names <- unlist(lapply(kegg_res, function(x) return(x$NAME)))
      full_names <- sub("\\[.*?\\]", "", full_names)
      full_names <- gsub ("\\/", "\n", full_names)
      full_names <- gsub (",", "\n", full_names)

      names(full_names) <- names(labels)
      tmp$variable <- paste(tmp$variable, "\n", full_names[tmp$variable], "\n", " p = ", labels[tmp$variable])
  }else{
      tmp$variable <- paste(tmp$variable, "\n", " p = ", labels[tmp$variable])
  }
  
  p <- ggplot(tmp, aes(x = log(value), y =diversity)) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(vars(variable), ncol = ncol, scale = "free") +
    theme_bw()+ theme(strip.background =element_rect(fill="white"))
  return(p)
}
```

# Plot correlation with alpha diversity
```{r}
deseq_metabol <- readRDS("../results/differential_analysis/metabol/deseq.rds")
plotCorrelationAlphaDiversity(toplot = rownames(deseq_metabol), ps = ps_metabol)
ggsave("../results/differential_analysis/metabol/correlation_deseq_diversity.pdf")

deseq_mtg <- readRDS("../results/differential_analysis/mtg/deseq.rds")
deseq_mtt <- readRDS("../results/differential_analysis/mtt/deseq.rds")
genes <- intersect(rownames(deseq_mtg), rownames(deseq_mtt))

plotCorrelationAlphaDiversity(toplot = genes, ps = ps_mtg, getGeneName = T)
ggsave("../results/differential_analysis/mtg/correlation_deseq_diversity.pdf", width = 4)

plotCorrelationAlphaDiversity(toplot = genes, ps = ps_mtt, getGeneName = T)
ggsave("../results/differential_analysis/mtt/correlation_deseq_diversity.pdf", width = 4)
```

# Correlation with Functional diversity
```{r}
plotCorrelationFunctionalDiversity <- function(toplot, ps, getGeneName = F, ncol = 1){

  df <- as.data.frame(t(ps@otu_table))
  df <- df[ , toplot, drop = F]
  
  df$diversity <- unlist(estimate_richness(ps, measures = "shannon"))
  df$age <- as.numeric(ps@sam_data$age)
  
  tmp <- melt(df, id = c("diversity", "age"))
  
  pvals <- sapply(unique(tmp$variable), function(x){
    tmp_use <- tmp[tmp$variable == x, ]
    res <- PResiduals::partial_Spearman(formula("diversity | value ~ age"), tmp_use)
    pval <- res$TS$TB$pval
    return(pval)
    #return(cor.test(tmp_use$value , tmp_use$stool_freq, method = "spearman")$p.value)
  })
  names(pvals) <- unique(tmp$variable)
  variables <- unique(tmp$variable)
  labels <- c(round(pvals[variables], 3))
  
  if(getGeneName){
       kegg_res <- keggGet(names(labels))
      full_names <- unlist(lapply(kegg_res, function(x) return(x$NAME)))
      full_names <- sub("\\[.*?\\]", "", full_names)
      full_names <- gsub ("\\/", "\n", full_names)
      full_names <- gsub (",", "\n", full_names)

      names(full_names) <- names(labels)
      tmp$variable <- paste(tmp$variable, "\n", full_names[tmp$variable], "\n", " p = ", labels[tmp$variable])
  }else{
      tmp$variable <- paste(tmp$variable, "\n", " p = ", labels[tmp$variable])
  }
  
  p <- ggplot(tmp, aes(x = log(value), y =diversity)) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(vars(variable), ncol = ncol, scale = "free") +
    theme_bw()+ theme(strip.background =element_rect(fill="white"))
  return(p)
}
```

# DESeq2 DA on only most severe cases and sibling controls
```{r}
runDEseqMostSevere <- function(ps){
  ps@sam_data$MARA <- as.numeric(ps@sam_data$MARA)
  mara_dist <- ps@sam_data$MARA[!is.na(ps@sam_data$MARA)]
  ps_severe <- prune_samples(ps@sam_data$MARA < mean(mara_dist), ps) #keep only those with scores below the first standard deviation
  familyIDs <- ps_severe@sam_data$familyID
  ps_use <- prune_samples(ps@sam_data$familyID %in% familyIDs, ps)
  deseq_res <- runDESeq(ps_use, dcut = 0.05)
}
deseq_mtg_severe <- runDEseqMostSevere(ps_mtg)
saveRDS(deseq_mtg_severe, "../results/differential_analysis/mtg/deseq_severe.rds")

deseq_mtt_severe <- runDEseqMostSevere(ps_mtt)
saveRDS(deseq_mtt_severe, "../results/differential_analysis/mtt/deseq_severe.rds")

deseq_metabol_severe <- runDEseqMostSevere(ps_metabol)
saveRDS(deseq_metabol_severe, "../results/differential_analysis/metabol/deseq_severe.rds")

```






# Why did we pick bile acids? Binomial test
```{r}
# On average, we would expect that differences between siblings would follow a binomial distribution around 0

getSiblingDiffs <- function(ps){
  seqtab <- t(as.data.frame(ps@otu_table)) #sample by ASV
  
  #For each sibling pair, find actual difference
  counts <- table(ps@sam_data$familyID)
  remove <- names(counts)[counts < 2]
  remove <- c(remove, "45") #both autism
  fam_ids <- unique(ps@sam_data$familyID)
  fam_ids <- fam_ids[!(fam_ids %in% remove)]
  
  actual_diffs <- lapply(fam_ids, function(fam_id){
    sib_aut <- sample_names(ps)[ps@sam_data$familyID == fam_id & ps@sam_data$phenotype == 'A']
    sib_nt <- sample_names(ps)[ps@sam_data$familyID == fam_id & ps@sam_data$phenotype == 'N']
    print(fam_id)
    return(seqtab[sib_aut, ] - seqtab[sib_nt, ])
  })
  actual_diffs <- do.call(rbind, actual_diffs)
  return(actual_diffs)
}

sibling_diffs <- getSiblingDiffs(ps_metabolite)

tests <- apply(sibling_diffs, 2, function(vec){
  std <- sd(vec)
  return(t.test(vec, rnorm(mean = 0, sd = std, n = 50000)))
})
pvals <- lapply(tests, function(x) return(x$p.value))
pvals <- unlist(pvals)
sum(pvals < .05, na.rm = T)
sum(p.adjust(pvals, 'fdr')<.05, na.rm = T)

padj <- p.adjust(pvals, 'fdr')
padj[padj < .05]
p_sig <- pvals[pvals < .05]
"ursodeoxycholate" %in% p_sig


seqtab <- as.data.frame(ps@otu_table)
aut <- seqtab['ursodeoxycholate', ps@sam_data$phenotype == "A"]
nt <- seqtab['ursodeoxycholate', ps@sam_data$phenotype == "N"]
boxplot(as.numeric(aut), as.numeric(nt))


# Bile acids are more likely to be enriched in NT
deseq_metabol <- list(res, sig)
bile_acids <- res[grepl("cholate", rownames(res)), ]
enriched_nt <- sum(bile_acids$log2FoldChange < 0)
total_draws <- length(bile_acids$log2FoldChange)
binom.test(enriched_nt, total_draws, 0.5, alternative = "two.sided")

# What about fatty acids
deseq_metabol <- list(res, sig)
fatty_acids <- res[grepl("oate", rownames(res)), ]
enriched_nt <- sum(fatty_acids$log2FoldChange < 0)
total_draws <- length(fatty_acids$log2FoldChange)
binom.test(enriched_nt, total_draws, 0.5, alternative = "two.sided")
```






















Correlation between those molecular markers and MARA score
```{r, fig.width=4, fig.height = 8}
metabolites_toplot <- rownames(deseq_metabol[[2]])
df <- as.data.frame(t(ps_metabol@otu_table))
df <- df[ , metabolites_toplot]
df$phenotype <- ifelse(ps_metabol@sam_data$phenotype == "A", 1, 0)
df$mara <- as.numeric(ps_metabol@sam_data$MARA)
df <- df[df$phenotype == 1, ]

tmp <- melt(df, id = c("phenotype", "mara"))
tmp$mara <- as.numeric(tmp$mara)
tmp$td_median <- medians[tmp$variable, 'median']

ggplot(tmp, aes(x = log(value/td_median), y = mara)) +
  geom_point() +
  facet_wrap(vars(variable), ncol = 1) +
  geom_smooth(method = "lm")+
 # stat_cor(label.y = 7, label.x = 0, aes(label = paste(..rr.label.., ..p.value..)))+
    stat_fit_glance(method = 'lm',
                  method.args = list(formula = "y~x"),
                  #geom = 'text',

                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")))
  theme_bw()+ theme(strip.background =element_rect(fill="white")) + ylim(c(-10, 8))

cor.test(tmp$value / tmp$td_median, tmp$mara, method = "spearman")
```

# Plot bile acids
```{r, fig.width = 8, fig.height = 7}
pattern = 'cholate'
sum(grepl(pattern, taxa_names(ps_metabol)))
metabolites_toplot <- taxa_names(ps_metabol)[grepl(pattern, taxa_names(ps_metabol))]
df <- as.data.frame(t(ps_metabol@otu_table))
df <- df[ , metabolites_toplot]
df$sums <- rowSums(df)
df$phenotype <- ifelse(ps_metabol@sam_data$phenotype == "A", 1, 0)

pvals <- apply(df, 2, function(x){
  wilcox.test(x[df$phenotype == 1], x[df$phenotype == 0])$p.value
})
p <- plotDensities(df, pvals, getGeneName = F, ncols = 5)
p


#sibling differences of bile acids, check if different from 0
source("functions.R")
sibling_diffs <- getActualDiffs(ps_metabol)
sibling_diffs <- sibling_diffs[ , metabolites_toplot]
pvals <- apply(sibling_diffs, 2, function(x){
  return(t.test(x)$p.value)
})

pvals
```

Plot genes with low p values from wald test
```{r}
df <- as.data.frame(t(ps_mtg@otu_table))
df$phenotype <- ifelse(ps_mtg@sam_data$phenotype == "A", 1, 0)

pvals <- sapply(colnames(df), function(x){
  f <- formula(paste("phenotype ~ ", x))
  line <- glm(f, data = df, family = "binomial")
  res <- wald.test(b = coef(line), Sigma = vcov(line), Terms = 1)
  pval <- res$result$chi2[3]
  return(pval)
})

sum(pvals < .02)
metabolites_toplot <- taxa_names(ps_mtg)[which(pvals < .01)]

df <- as.data.frame(t(ps_mtg@otu_table))
df <- df[ , metabolites_toplot]
df$phenotype <- ifelse(ps_mtg@sam_data$phenotype == "A", 1, 0)
p <- plotDensities(df, ncols = 3)
p

```


Is there a correlation between K20265 (glutamate:GABA antiporter) and anxiety? No
```{r}
getwd()

ps <- readRDS("../data/mtg/PS_biocyc_MTG_age_filtered.rds")
anxiety <- ps@sam_data$Recent.anxiety..caretaker.reported...Biospecimen.
imaginary_play <- ps@sam_data$Plays.imaginatively.with.others..Biospecimen.
group_play <- ps@sam_data$Plays.in.a.group.with.others..Biospecimen.
eye_contact <- ps@sam_data$Eye.contact.finding..Biospecimen.


anxiety[anxiety == "No elevated anxiety"] = 0
anxiety[anxiety == "Somewhat elevated anxiety"] = 1
anxiety[anxiety == "Elevated anxiety"] = 2
anxiety <- as.numeric(anxiety)
names(anxiety) <- ps@sam_data$Biospecimen.Name

imaginary_play[imaginary_play == "Never"] = 0
imaginary_play[imaginary_play == "Rarely"] = 1
imaginary_play[imaginary_play == "Sometimes"] = 2
imaginary_play <- as.numeric(imaginary_play)
names(imaginary_play) <- ps@sam_data$Biospecimen.Name

group_play[group_play == "Never"] = 0
group_play[group_play == "Rarely"] = 1
group_play[group_play == "Sometimes"] = 2
group_play <- as.numeric(group_play)
names(group_play) <- ps@sam_data$Biospecimen.Name

eye_contact[eye_contact == "Little or no eye contact"]=0
eye_contact[eye_contact == "Some eye contact"]=1
eye_contact[eye_contact == "Consistent eye contact"]=2
eye_contact <- as.numeric(eye_contact)
names(eye_contact) <- ps@sam_data$Biospecimen.Name

#transporter and carboxythyl GABA related to anxiety
feature <- ps_metabol@otu_table[rownames(deseq_metabol[[2]])[5], ps_metabol@sam_data$phenotype == "A"] 
plot(as.numeric(feature), anxiety[colnames(feature)])
cor.test(as.numeric(feature), anxiety[colnames(feature)], method = "spearman")
cor.test(as.numeric(feature), imaginary_play[colnames(feature)], method = "spearman")
cor.test(as.numeric(feature), group_play[colnames(feature)], method = "spearman")
cor.test(as.numeric(feature), eye_contact[colnames(feature)], method = "spearman")

```